# Lorelm AI角色扮演系统架构

## 执行摘要

Lorelm是一款基于AI的角色扮演网页应用，允许用户通过语音聊天和文本消息与虚拟角色互动。该系统采用FastAPI后端与PostgreSQL数据库，使用elasticsearch进行向量搜索，前端采用Vue 3与Vite构建。架构遵循清晰架构模式，实现了关注点分离。

## 需求实现

### 1. 构思角色扮演

#### 1.1 角色创建与管理
- **角色模板系统**: 提供预设角色模板（历史人物、文学角色、自定义角色）
- **角色属性设计**:
  - 基本信息：昵称、头像、描述、首条消息
  - 个性化设置：性格特征、说话风格、知识领域
  - 外观定制：头像上传、形象描述
- **角色关联**: 支持角色与世界观的关联，构建完整的故事背景

#### 1.2 角色知识库
- **文档管理**: 支持上传、编辑、删除角色相关文档
- **知识向量化**: 将角色背景、设定、对话历史转化为向量嵌入
- **智能提示**: 基于角色背景自动生成对话提示词
- **记忆系统**: 保存对话上下文，保持角色一致性

#### 1.3 角色搜索与发现
- **标签系统**: 自定义标签分类，支持多维度筛选
- **语义搜索**: 基于向量相似性的角色推荐
- **模糊搜索**: 支持昵称、描述的关键词搜索
- **热度排行**: 基于用户互动的角色排行系统

### 2. 关联对话知识管理

#### 2.1 对话会话管理
- **会话创建**: 支持单人角色对话、多角色对话
- **会话分类**: 按世界、角色、时间维度组织对话
- **会话状态**: 实时会话、历史会话、收藏会话
- **会话转移**: 支持在不同角色间切换对话

#### 2.2 知识图谱构建
- **实体识别**: 自动识别对话中的关键实体
- **关系抽取**: 构建角色、用户、概念之间的关系网络
- **知识更新**: 实时更新角色知识库，保持信息新鲜
- **上下文管理**: 维护对话历史和上下文连贯性

#### 2.3 智能知识检索
- **向量化检索**: 基于语义相似性的知识检索
- **关键词搜索**: 支持精确匹配和模糊搜索
- **组合检索**: 向量搜索+关键词搜索的混合检索
- **排序优化**: 基于相关性、时间、热度的智能排序

### 3. 对话融入世界、角色

#### 3.1 世界观构建
- **世界设定**: 支持创建自定义世界观（历史时期、奇幻世界、科幻场景）
- **环境描述**: 世界背景、场景描述、时间线设置
- **规则系统**: 世界运行的规则和限制
- **氛围营造**: 通过音效、背景、描述营造沉浸感

#### 3.2 角色行为一致性
- **性格约束**: 基于角色性格的对话行为约束
- **知识边界**: 角色知识的边界和限制
- **情感表达**: 基于角色特征的情感表达方式
- **语言风格**: 符合角色身份的语言习惯和用词

#### 3.3 沉浸式体验设计
- **多模态交互**: 文字、语音、图像、视频的综合交互
- **实时反馈**: 角色的即时回应和情感表达
- **记忆延续**: 跨会话的记忆和情感延续
- **个性化定制**: 根据用户偏好调整交互深度

## 核心价值实现

| 需求层次 | 技术实现 | 用户价值 |
|---------|---------|---------|
| **角色扮演** | 角色模型 + 知识库 + 提示词工程 | 沉浸式角色体验 |
| **知识管理** | 向量搜索 + 知识图谱 + 上下文管理 | 智能对话支撑 |
| **世界融合** | 世界观设定 + 角色行为约束 + 氛围营造 | 沉浸式体验 |

### 实现优势

1. **高度个性化**: 基于角色背景和用户偏好的定制化体验
2. **知识连贯性**: 通过向量搜索和知识图谱保持信息一致性
3. **实时交互**: WebSocket支持的低延迟实时对话
4. **可扩展性**: 模块化设计支持快速迭代和功能扩展

## 系统架构概览

### 高层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Lorelm 系统                              │
├─────────────────────────────────────────────────────────────────┤
│  前端 (Vue 3 + Vite + Element Plus)                            │
│  • 用户界面                                                    │
│  • 语音聊天 (语音识别+语音合成)                                │
│  • 实时消息传递                                                │
│  • 角色管理                                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      后端 (FastAPI)                             │
│  • RESTful API                                                  │
│  • WebSocket支持                                                │
│  • 大语言模型集成 (Modelscope)                                  │
│  • 向量搜索 (elasticsearch)                                     │
│  • 文件存储 (MinIO)                                             │
│  • 认证与授权                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    数据库 (PostgreSQL)                          │
│  • 用户管理                                                     │
│  • 角色与世界数据                                               │
│  • 对话历史                                                     │
│  • 软删除支持                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                向量数据库 (Elasticsearch)                       │
│  • 分块内容                                                     │
│  • 粗分词内容                                                   │
│  • 细分词内容                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 详细架构

### 1. 前端架构

#### 1.1 技术栈
- **框架**: Vue 3 组合式API
- **构建工具**: Vite
- **UI库**: Element Plus + Tailwind CSS
- **状态管理**: 带持久化的Pinia
- **路由**: Vue Router 4
- **Markdown**: 支持KaTeX的markdown-it
- **图标**: Iconify

#### 1.2 组件结构
```
前端代码/src/
├── components/
│   ├── ChatInput.vue          # 语音和文本输入
│   ├── ChatHistory.vue       # 消息显示
│   ├── MagicCard.vue          # 角色卡片
│   └── MarkdownRender/       # Markdown渲染器
├── views/
│   ├── login.vue            # 认证页面
│   ├── index.vue             # 主界面
│   ├── admin/                # 管理面板
│   │   └── user.vue         # 用户管理
│   ├── index/
│   │   ├── character/        # 角色管理
│   │   ├── world/            # 世界管理
│   │   └── dialog/           # 聊天界面
│   └── [...path].vue        # 全捕获路由
├── api/                     # API客户端
├── schemas/                 # TypeScript接口
├── types/                   # 类型定义
├── utils/                   # 工具函数
└── assets/                  # 静态资源
```

#### 1.3 关键特性
- **实时语音聊天**: 基于WebSocket的语音通信
- **角色搜索**: 支持标签和筛选的高级搜索
- **交互式消息**: 支持富文本和markdown
- **响应式设计**: 移动端友好界面
- **状态持久化**: 用户偏好和对话历史

### 2. 后端架构

#### 2.1 技术栈
- **框架**: 支持异步的FastAPI
- **数据库**: 带pgvector扩展的PostgreSQL
- **ORM**: 支持异步的SQLAlchemy
- **认证**: 带刷新令牌的JWT
- **向量搜索**: 用于嵌入向量的pgvector
- **大语言模型集成**: Modelscope API
- **文件存储**: 用于对象存储的MinIO
- **中间件**: CORS、日志记录、异常处理

#### 2.2 应用结构
```
后端代码/
├── __init__.py              # 应用工厂
├── api/                    # API端点
│   └── v1/
│       ├── admin/          # 用户管理
│       ├── character/      # 角色API
│       ├── conversation/   # 聊天API
│       └── label/          # 标签管理
├── models/                 # 数据库模型
│   ├── admin.py           # 用户模型
│   ├── character.py       # 角色/世界/文档模型
│   ├── conversation.py    # 聊天会话模型
│   └── base.py            # 基类
├── schemas/                # Pydantic模式
│   ├── admin.py           # 用户模式
│   ├── character.py       # 角色模式
│   ├── conversation.py    # 聊天模式
│   └── base.py            # 基础模式
├── crud/                   # 数据库操作
├── dependencies/          # 依赖注入
├── exceptions/            # 异常处理
├── utils/                 # 工具函数
└── resources/             # 静态资源
```

#### 2.3 关键组件

##### 2.3.1 应用工厂
- `create_app()`: 主应用工厂函数
- `lifespan()`: 用于启动/关闭的异步上下文管理器
- `make_middlewares()`: 中间件配置
- 异常注册和日志设置

##### 2.3.2 数据库模型
- **基类**:
  - `DbBase`: SQLAlchemy声明式基类
  - `TableBase`: 带ID字段的基础类
  - `ORMBaseSmall`: 带创建时间戳的基础类
  - `ORMBase`: 支持软删除的完整基础类

- **核心模型**:
  - `User`: 带认证的用户管理
  - `Character`: 带头像和描述的虚拟角色
  - `World`: 带设置的角色世界
  - `Document`: 知识库文档
  - `Label`: 分类标签
  - `ConversationSession`: 聊天会话
  - `ConversationHistory`: 消息历史

##### 2.3.3 API结构
- **管理模块**: 用户管理和认证
- **角色模块**: 角色CRUD操作
- **世界模块**: 世界管理
- **对话模块**: 实时聊天
- **标签模块**: 标签管理

#### 2.4 数据库架构

##### 2.4.1 模式设计
```
数据表:
├── user                    # 用户账户
│   ├── id, email, nickname
│   ├── password_hash, avatar
│   ├── created_at, updated_at
│   └── 软删除字段
├── label                   # 角色标签
├── world                   # 角色世界
│   ├── nickname, description
│   ├── user_id, data_range
│   └── labels (多对多)
├── character               # 虚拟角色
│   ├── nickname, description
│   ├── first_message, avatar
│   ├── user_id, world_id
│   └── labels, docs 关系
├── document                # 知识文档
│   ├── character_id, world_id
│   ├── content, embedding
│   └── disabled 标志
├── conversation_session    # 聊天会话
│   ├── user_id, world_id
│   ├── title, token_usage
│   └── characters 关系
└── conversation_history    # 消息记录
    ├── session_id, role
    ├── content, reasoning
    ├── token_usage
    └── 时间戳
```

##### 2.4.2 关系
- **用户 → 角色/世界**: 一对多
- **角色 → 标签**: 多对多
- **世界 → 角色**: 一对多
- **世界 → 标签**: 多对多
- **会话 → 角色**: 多对多
- **会话 → 消息**: 一对多

##### 2.4.3 向量存储
- **pgvector集成**: 用于语义搜索
- **文档嵌入**: 角色知识库
- **搜索能力**: 向量相似性搜索

#### 2.5 API架构

##### 2.5.1 RESTful端点
```
/v1/admin/
├── POST /login           # 用户认证
├── GET /users           # 用户列表
├── POST /users          # 创建用户
└── PUT /users/{id}     # 更新用户

/v1/character/
├── GET /characters      # 角色列表
├── POST /characters     # 创建角色
├── PUT /characters/{id} # 更新角色
├── DELETE /characters/{id} # 删除角色
└── GET /characters/search # 搜索角色

/v1/world/
├── GET /worlds         # 世界列表
├── POST /worlds        # 创建世界
├── PUT /worlds/{id}    # 更新世界
└── DELETE /worlds/{id} # 删除世界

/v1/conversation/
├── GET /sessions       # 会话列表
├── POST /sessions      # 创建会话
├── WS /sessions/{id}   # WebSocket聊天
└── GET /sessions/{id}/history # 获取历史

/v1/label/
├── GET /labels         # 标签列表
├── POST /labels        # 创建标签
├── PUT /labels/{id}    # 更新标签
└── DELETE /labels/{id} # 删除标签
```

##### 2.5.2 认证与授权
- **JWT令牌**: 访问和刷新令牌
- **数据范围**: `all`、`self`、`custom`权限
- **基于角色的访问**: 管理员与普通用户
- **软删除**: 带审计追踪的逻辑删除

### 3. 数据流架构

#### 3.1 聊天流程
```
用户输入 → WebSocket → 语音识别 → 大语言模型 → 语音合成 → 音频输出
     ↓            ↓        ↓         ↓           ↓
  文本输入     会话管理   向量搜索   提示构建    响应生成
  处理过程
```

#### 3.2 角色创建流程
```
用户输入 → 验证 → 向量嵌入 → 数据库存储
     ↓         ↓         ↓          ↓
  表单数据 → 模式检查 → 文档处理 → 角色创建
```

#### 3.3 搜索流程
```
搜索查询 → 文本处理 → 向量搜索 → 结果排序
     ↓         ↓           ↓          ↓
  关键词 → 分词处理 → 相似性搜索 → 角色展示
```

### 4. 安全架构

#### 4.1 认证
- **JWT令牌**: 无状态认证
- **密码哈希**: 带盐值的bcrypt
- **刷新令牌**: 令牌轮换机制
- **会话管理**: 安全会话处理

#### 4.2 授权
- **基于角色的访问**: 管理员和普通用户角色
- **数据范围**: 细粒度权限控制
- **软删除**: 数据完整性和审计追踪

#### 4.3 数据保护
- **输入验证**: Pydantic模式验证
- **SQL注入预防**: SQLAlchemy ORM
- **XSS预防**: 输出编码
- **CSRF保护**: 基于令牌的验证

### 5. 部署架构

#### 5.1 容器化
- **Docker**: 应用容器化
- **Docker Compose**: 多容器编排
- **PostgreSQL**: 数据库服务
- **MinIO**: 对象存储服务

#### 5.2 环境配置
- **开发环境**: 本地开发环境
- **生产环境**: 生产部署设置
- **环境变量**: 配置管理
- **日志记录**: 带彩色输出的结构化日志

### 6. 可扩展性考虑

#### 6.1 水平扩展
- **负载均衡**: 多后端实例
- **数据库连接池**: SQLAlchemy连接池
- **缓存**: 用于会话和缓存管理的Redis

#### 6.2 性能优化
- **向量搜索**: 用于高效相似性搜索的pgvector
- **数据库索引**: 适当的索引策略
- **缓存**: 用于频繁查询的Redis
- **异步处理**: FastAPI异步支持

### 7. 监控与维护

#### 7.1 日志记录
- **结构化日志**: JSON格式日志
- **错误追踪**: 异常处理和报告
- **性能指标**: 请求/响应计时

#### 7.2 数据库管理
- **Alembic**: 数据库迁移
- **健康检查**: 数据库连接监控
- **备份策略**: 定期备份和恢复

### 8. 集成点

#### 8.1 外部服务
- **Modelscope API**: 大语言模型集成
- **MinIO**: 文件对象存储
- **WebSocket**: 实时通信

#### 8.2 内部组件
- **认证**: JWT和用户管理
- **向量搜索**: 用于语义搜索的pgvector
- **文件处理**: 文档和图像处理

## 结论

Lorelm系统遵循现代化、可扩展的架构，实现了清晰的关注点分离。FastAPI、PostgreSQL和Vue 3的组合为AI驱动的角色扮演平台提供了坚实的基础。该架构支持实时功能、向量搜索能力和用户认证，同时保持了安全性和性能标准。